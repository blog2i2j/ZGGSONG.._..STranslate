<ui:Page
    x:Class="STranslate.Views.Pages.PluginPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:cnvt="clr-namespace:STranslate.Converters"
    xmlns:control="clr-namespace:STranslate.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:ikw="http://schemas.inkore.net/lib/ui/wpf"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:plugin="clr-namespace:STranslate.Plugin;assembly=STranslate.Plugin"
    xmlns:s="https://github.com/zggsong/2022/xaml"
    xmlns:ui="http://schemas.inkore.net/lib/ui/wpf/modern"
    xmlns:vm="clr-namespace:STranslate.ViewModels.Pages"
    Title="Plugin"
    d:DataContext="{d:DesignInstance Type=vm:PluginViewModel,
                                     IsDesignTimeCreatable=False}"
    d:DesignHeight="450"
    d:DesignWidth="800"
    mc:Ignorable="d">
    <ui:Page.Resources>
        <s:BindingProxy x:Key="ViewModelProxy" Data="{Binding .}" />
    </ui:Page.Resources>
    <Grid AllowDrop="True">
        <i:Interaction.Triggers>
            <i:EventTrigger EventName="DragEnter">
                <i:ChangePropertyAction
                    PropertyName="Visibility"
                    TargetObject="{Binding ElementName=PART_DropPanel}"
                    Value="Visible" />
            </i:EventTrigger>
            <i:EventTrigger EventName="DragLeave">
                <i:ChangePropertyAction
                    PropertyName="Visibility"
                    TargetObject="{Binding ElementName=PART_DropPanel}"
                    Value="Collapsed" />
            </i:EventTrigger>
            <i:EventTrigger EventName="Drop">
                <i:ChangePropertyAction
                    PropertyName="Visibility"
                    TargetObject="{Binding ElementName=PART_DropPanel}"
                    Value="Collapsed" />
                <i:InvokeCommandAction Command="{Binding InstallPluginsCommand}" PassEventArgsToCommand="True" />
            </i:EventTrigger>
        </i:Interaction.Triggers>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <DockPanel Grid.Row="0" Margin="20,10,0,12">
            <TextBlock
                DockPanel.Dock="Left"
                Style="{DynamicResource {x:Static ui:ThemeKeys.SubtitleTextBlockStyleKey}}"
                Text="{DynamicResource Plugins}" />
            <ikw:SimpleStackPanel
                HorizontalAlignment="Right"
                VerticalAlignment="Center"
                DockPanel.Dock="Right"
                Orientation="Horizontal"
                Spacing="10">
                <Button Command="{Binding MarketCommand}" Style="{DynamicResource {x:Static ui:ThemeKeys.AccentButtonStyleKey}}">
                    <ui:IconAndText Content="{DynamicResource Market}" Icon="{x:Static ui:FluentSystemIcons.Apps_20_Regular}" />
                </Button>

                <Button Command="{Binding AddPluginCommand}">
                    <ui:IconAndText Content="{DynamicResource AddPlugin}" Icon="{x:Static ui:FluentSystemIcons.AppsAddIn_20_Regular}" />
                </Button>

                <ComboBox
                    MaxWidth="200"
                    DisplayMemberPath="Display"
                    ItemsSource="{Binding DataProvider.PluginTypes}"
                    SelectedValue="{Binding PluginType}"
                    SelectedValuePath="Value" />
                <TextBox
                    x:Name="PluginFilterTextbox"
                    Width="150"
                    VerticalAlignment="Center"
                    ui:ControlHelper.PlaceholderText="{DynamicResource SearchPlugin}"
                    Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}"
                    TextAlignment="Left"
                    ToolTip="{DynamicResource SearchPluginToolTip}"
                    ToolTipService.InitialShowDelay="200"
                    ToolTipService.Placement="Top" />
            </ikw:SimpleStackPanel>
        </DockPanel>

        <Border Grid.Row="1" Margin="20,0,20,0">
            <ListBox
                x:Name="PART_PluginListBox"
                control:ListBoxSelectionBehavior.AutoDeselectPrePlugins="True"
                Background="Transparent"
                ItemsSource="{Binding PluginCollectionView}"
                ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                ScrollViewer.VerticalScrollBarVisibility="Auto">
                <ListBox.Resources>
                    <s:BindingProxy x:Key="VmProxy" Data="{Binding}" />
                </ListBox.Resources>
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel HorizontalAlignment="Center" IsItemsHost="True" />
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="0,0,12,12" />
                        <Setter Property="Background" Value="Transparent" />
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <ContentPresenter />
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="plugin:PluginMetaData">
                        <Border
                            Width="280"
                            MinHeight="90"
                            Padding="12"
                            Background="{DynamicResource {x:Static ui:ThemeKeys.CardBackgroundFillColorDefaultBrushKey}}"
                            BorderBrush="{DynamicResource {x:Static ui:ThemeKeys.CardStrokeColorDefaultBrushKey}}"
                            BorderThickness="1"
                            CornerRadius="8">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Opacity" Value="1" />
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="{DynamicResource {x:Static ui:ThemeKeys.SystemFillColorAttentionBackgroundBrushKey}}" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="10" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <!--  左侧图标  -->
                                <Image
                                    Grid.Column="0"
                                    Width="32"
                                    Height="32"
                                    VerticalAlignment="Center"
                                    Source="{Binding IconPath}"
                                    Stretch="Uniform" />

                                <!--  右侧内容  -->
                                <Grid Grid.Column="2">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" MinHeight="20" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <!--  标题行  -->
                                    <Grid Grid.Row="0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <TextBlock
                                            Grid.Column="0"
                                            VerticalAlignment="Center"
                                            FontSize="{DynamicResource STControlFontSize13}"
                                            FontWeight="SemiBold"
                                            Text="{Binding Name}"
                                            TextTrimming="CharacterEllipsis" />

                                        <!--  操作按钮组  -->
                                        <ikw:SimpleStackPanel
                                            Grid.Column="1"
                                            Margin="8,0,0,0"
                                            VerticalAlignment="Center"
                                            Orientation="Horizontal"
                                            Spacing="8">
                                            <ikw:SimpleStackPanel.Resources>
                                                <Style x:Key="ActionIconStyle" TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorSecondaryBrushKey}}" />
                                                    <Setter Property="VerticalAlignment" Value="Center" />
                                                    <Setter Property="Cursor" Value="Hand" />
                                                    <Setter Property="FontFamily" Value="{DynamicResource FluentSystemIcons}" />
                                                    <Setter Property="FontSize" Value="{DynamicResource STControlFontSize16}" />
                                                    <Setter Property="Padding" Value="4" />
                                                    <Setter Property="Background" Value="Transparent" />
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Foreground" Value="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorPrimaryBrushKey}}" />
                                                        </Trigger>
                                                        <Trigger Property="IsEnabled" Value="False">
                                                            <Setter Property="Foreground" Value="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorDisabledBrushKey}}" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ikw:SimpleStackPanel.Resources>
                                            <!--  官网链接  -->
                                            <TextBlock Style="{StaticResource ActionIconStyle}" Text="&#xF480;">
                                                <TextBlock.InputBindings>
                                                    <MouseBinding
                                                        Command="{Binding Source={StaticResource VmProxy}, Path=Data.OpenOfficialLinkCommand}"
                                                        CommandParameter="{Binding Website}"
                                                        MouseAction="LeftClick" />
                                                </TextBlock.InputBindings>
                                            </TextBlock>
                                            <!--  删除  -->
                                            <TextBlock
                                                IsEnabled="{Binding IsPrePlugin, Converter={cnvt:BoolInverseConverter}}"
                                                Style="{StaticResource ActionIconStyle}"
                                                Text="&#xF34C;">
                                                <TextBlock.InputBindings>
                                                    <MouseBinding
                                                        Command="{Binding Source={StaticResource VmProxy}, Path=Data.DeletePluginCommand}"
                                                        CommandParameter="{Binding}"
                                                        MouseAction="LeftClick" />
                                                </TextBlock.InputBindings>
                                            </TextBlock>
                                            <!--  打开目录  -->
                                            <TextBlock Style="{StaticResource ActionIconStyle}" Text="&#xF418;">
                                                <TextBlock.InputBindings>
                                                    <MouseBinding
                                                        Command="{Binding Source={StaticResource VmProxy}, Path=Data.OpenPluginDirectoryCommand}"
                                                        CommandParameter="{Binding}"
                                                        MouseAction="LeftClick" />
                                                </TextBlock.InputBindings>
                                            </TextBlock>
                                        </ikw:SimpleStackPanel>
                                    </Grid>

                                    <!--  描述  -->
                                    <TextBlock
                                        Grid.Row="1"
                                        MaxHeight="32"
                                        Margin="0,3,0,0"
                                        FontSize="{DynamicResource STControlFontSize12}"
                                        Foreground="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorSecondaryBrushKey}}"
                                        LineHeight="16"
                                        Text="{Binding Description}"
                                        TextTrimming="CharacterEllipsis"
                                        TextWrapping="Wrap" />

                                    <!--  底部：作者、版本  -->
                                    <TextBlock
                                        Grid.Row="2"
                                        Margin="0,6,0,0"
                                        VerticalAlignment="Center"
                                        FontSize="{DynamicResource STControlFontSize11}"
                                        Foreground="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorTertiaryBrushKey}}"
                                        TextTrimming="CharacterEllipsis">
                                        <TextBlock.Text>
                                            <MultiBinding StringFormat="{}{0} · v{1}">
                                                <Binding Path="Author" />
                                                <Binding Path="Version" />
                                            </MultiBinding>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Border>

        <ikw:SimpleStackPanel
            Grid.Row="2"
            Margin="0,4"
            HorizontalAlignment="Center"
            Orientation="Horizontal"
            Spacing="12">
            <ikw:SimpleStackPanel.Resources>
                <Style BasedOn="{StaticResource {x:Type TextBlock}}" TargetType="TextBlock">
                    <Setter Property="Foreground" Value="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorSecondaryBrushKey}}" />
                    <Setter Property="FontSize" Value="{DynamicResource STControlFontSize12}" />
                </Style>
            </ikw:SimpleStackPanel.Resources>
            <TextBlock>
                <Run Text="{DynamicResource PluginTypeAll}" />
                <Run Text=": " />
                <Run Text="{Binding TotalPluginCount, Mode=OneWay}" />
            </TextBlock>
            <TextBlock>
                <Run Text="{DynamicResource PluginTypeTranslate}" />
                <Run Text=": " />
                <Run Text="{Binding TranslatePluginCount, Mode=OneWay}" />
            </TextBlock>
            <TextBlock>
                <Run Text="{DynamicResource PluginTypeOcr}" />
                <Run Text=": " />
                <Run Text="{Binding OcrPluginCount, Mode=OneWay}" />
            </TextBlock>
            <TextBlock>
                <Run Text="{DynamicResource PluginTypeTts}" />
                <Run Text=": " />
                <Run Text="{Binding TtsPluginCount, Mode=OneWay}" />
            </TextBlock>
            <TextBlock>
                <Run Text="{DynamicResource PluginTypeVocabulary}" />
                <Run Text=": " />
                <Run Text="{Binding VocabularyPluginCount, Mode=OneWay}" />
            </TextBlock>
        </ikw:SimpleStackPanel>

        <Grid
            Name="PART_DropPanel"
            Grid.RowSpan="3"
            Visibility="Collapsed">
            <Border Background="{DynamicResource {x:Static ui:ThemeKeys.SystemControlBackgroundChromeBlackMediumLowBrushKey}}" CornerRadius="6" />
            <StackPanel
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Orientation="Horizontal">
                <ui:FontIcon
                    FontSize="{DynamicResource STControlFontSize18}"
                    Foreground="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorInverseBrushKey}}"
                    Icon="{x:Static ui:FluentSystemIcons.AppsAddIn_20_Regular}" />
                <TextBlock
                    Margin="5,0,0,0"
                    Foreground="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorInverseBrushKey}}"
                    Text="{DynamicResource DropInstallPlugin}" />
            </StackPanel>
            <Rectangle
                Width="250"
                MaxHeight="80"
                RadiusX="10"
                RadiusY="10"
                Stroke="{DynamicResource {x:Static ui:ThemeKeys.TextFillColorInverseBrushKey}}"
                StrokeDashArray="3"
                StrokeThickness="2" />
        </Grid>
    </Grid>
</ui:Page>